{% extends "base.html" %}
{% block title %}{{ artist.name }} — Lyrics Library{% endblock %}
{% block content %}

<div class="page-container py-8 sm:py-12">
  <!-- Artist Header -->
  <section class="mb-10 sm:mb-12">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12 items-start">
      <!-- Artist Image -->
      <div class="flex justify-center md:justify-start">
        <div class="w-64 h-64 sm:w-80 sm:h-80 md:w-96 md:h-96 rounded-2xl overflow-hidden bg-gradient-to-br from-white/20 to-white/10 shadow-2xl ring-2 ring-white/20">
          {% if artist.image_url %}
          <img src="{{ artist.image_url }}"
               alt="{{ artist.name }}"
               class="w-full h-full object-cover"
               loading="lazy">
          {% else %}
          <div class="w-full h-full flex items-center justify-center text-8xl sm:text-9xl font-bold text-white/80">
            {{ artist.name|first|upper }}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Artist Info -->
      <div class="space-y-4 sm:space-y-6 text-center md:text-left">
        <div>
          <h1 class="heading-1 mb-4">{{ artist.name }}</h1>

          <div class="flex flex-wrap gap-4 justify-center md:justify-start text-white/70">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
              </svg>
              <span>{% with cnt=songs|length %}{{ cnt }} song{{ cnt|pluralize }}{% endwith %}</span>
            </div>
            {% if year_min and year_max %}
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span>{{ year_min }}–{{ year_max }}</span>
            </div>
            {% endif %}
            {% if view_count %}
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              <span>{{ view_count|floatformat:0 }} view{{ view_count|pluralize }}</span>
            </div>
            {% endif %}
          </div>
        </div>

        {% if avg_rating %}
        <div>
          <p class="text-white/80">Average Rating: <span class="text-yellow-400 font-semibold text-lg">{{ avg_rating|floatformat:1 }}/5.0</span></p>
        </div>
        {% endif %}

        {% if artist.about %}
        <div class="card">
          <h2 class="heading-3 mb-3">About</h2>
          <p class="text-white/85 leading-relaxed">{{ artist.about }}</p>
        </div>
        {% endif %}

        {% if user.is_authenticated %}
        <div>
          <form method="post" action="{% url 'toggle_favorite_artist' artist.id %}">
            {% csrf_token %}
            <button type="submit" class="btn-secondary {% if is_favorite %}text-red-400{% endif %}">
              {% if is_favorite %}♥ Favorited{% else %}♡ Add to Favorites{% endif %}
            </button>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Songs Grid -->
  <section>
    <div class="flex items-end justify-between mb-6">
      <h2 class="heading-2">Songs</h2>
    </div>

    {% if songs %}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6">
      {% for song in songs %}
      <a href="{% url 'song_detail' artist=artist.slug song=song.slug %}"
         class="group">
        <!-- Song Cover -->
        <div class="aspect-square rounded-xl overflow-hidden bg-gradient-to-br from-white/15 to-white/5 mb-3 ring-2 ring-white/10 group-hover:ring-emerald-400/60 transition-all duration-300 shadow-lg group-hover:shadow-2xl group-hover:scale-105">
          {% if song.get_image_url %}
          <img src="{{ song.get_image_url }}"
               alt="{{ song.title }}"
               class="w-full h-full object-cover group-hover:brightness-110 transition-all duration-300"
               loading="lazy">
          {% else %}
          <div class="w-full h-full flex items-center justify-center text-3xl sm:text-4xl font-bold text-white/80 group-hover:text-white transition-colors">
            {{ song.title|first|upper }}
          </div>
          {% endif %}
        </div>

        <!-- Song Info -->
        <div class="px-1">
          <h3 class="font-semibold text-sm line-clamp-2 mb-1 group-hover:text-emerald-400 transition-colors">
            {{ song.title }}
          </h3>
          {% if song.year %}
          <p class="text-xs text-white/50">{{ song.year }}</p>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </div>
    {% else %}
    <div class="card text-center py-12">
      <p class="text-white/60">No songs available yet</p>
    </div>
    {% endif %}
  </section>

  <!-- Ratings Section -->
  {% if user.is_authenticated %}
  <section class="mt-10 sm:mt-12">
    <div class="card">
      <h2 class="heading-3 mb-4">Rate This Artist</h2>
      <form method="post" id="ratingForm" class="space-y-4">
        {% csrf_token %}
        <div class="flex gap-4 items-center">
          <div class="star-rating" data-rating="{{ user_rating.rating|default:0 }}">
            <input type="hidden" name="rating" id="ratingInput" value="{{ user_rating.rating|default:0 }}">
            <span class="star" data-value="1">★</span>
            <span class="star" data-value="2">★</span>
            <span class="star" data-value="3">★</span>
            <span class="star" data-value="4">★</span>
            <span class="star" data-value="5">★</span>
          </div>
          <button type="submit" class="btn-secondary text-sm">Submit Rating</button>
        </div>
        {% if user_rating %}
        <p class="text-sm text-white/60">Your current rating: <span id="currentRating">{{ user_rating.rating }}</span>/5</p>
        {% endif %}
      </form>
    </div>
  </section>
  {% endif %}

  <!-- Comments Section -->
  <section class="mt-10 sm:mt-12">
    <div class="card">
      <h2 class="heading-3 mb-6">Comments</h2>

      {% if user.is_authenticated %}
      <form method="post" class="mb-8">
        {% csrf_token %}
        {{ comment_form.text }}
        <input type="hidden" name="comment_text" value="1">
        <button type="submit" class="mt-3 btn-secondary text-sm">Post Comment</button>
      </form>
      {% else %}
      <p class="mb-8 text-white/60">
        <a href="{% url 'login' %}?next={{ request.path }}" class="link">Login</a> to leave a comment
      </p>
      {% endif %}

      {% if comments %}
      <div class="space-y-4">
        {% for comment in comments %}
        <div class="p-4 bg-white/5 rounded-lg border border-white/10">
          <div class="flex justify-between items-start mb-2">
            <span class="font-semibold">{{ comment.user.username }}</span>
            <span class="text-xs text-white/50">{{ comment.created_at|timesince }} ago</span>
          </div>
          <p class="text-white/80">{{ comment.text }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-white/60">No comments yet. Be the first to comment!</p>
      {% endif %}
    </div>
  </section>
</div>

<style>
  .star-rating {
    display: inline-flex;
    gap: 0.25rem;
    font-size: 2rem;
    cursor: pointer;
  }
  .star {
    color: rgba(255, 255, 255, 0.2);
    transition: color 0.2s;
    cursor: pointer;
  }
  .star.filled {
    color: #fbbf24;
  }
  .star:hover {
    color: #fbbf24;
  }
</style>

<script>
  // Star rating functionality
  document.addEventListener('DOMContentLoaded', function() {
    const starRating = document.querySelector('.star-rating');
    if (!starRating) return;

    const stars = starRating.querySelectorAll('.star');
    const ratingInput = document.getElementById('ratingInput');
    const currentRatingSpan = document.getElementById('currentRating');
    let currentRating = parseInt(starRating.dataset.rating) || 0;

    // Initialize stars based on current rating
    function updateStars(rating) {
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.add('filled');
        } else {
          star.classList.remove('filled');
        }
      });
    }

    updateStars(currentRating);

    // Hover effect
    stars.forEach((star, index) => {
      star.addEventListener('mouseenter', () => {
        updateStars(index + 1);
      });
    });

    // Reset to current rating on mouse leave
    starRating.addEventListener('mouseleave', () => {
      updateStars(currentRating);
    });

    // Click to select rating
    stars.forEach((star, index) => {
      star.addEventListener('click', () => {
        currentRating = index + 1;
        ratingInput.value = currentRating;
        updateStars(currentRating);
        if (currentRatingSpan) {
          currentRatingSpan.textContent = currentRating;
        }
      });
    });
  });
</script>
{% endblock %}
