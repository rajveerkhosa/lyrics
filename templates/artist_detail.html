{% extends "base.html" %}
{% block title %}{{ artist.name }} — Lyrics Library{% endblock %}
{% block content %}

<!-- Full-bleed background with dark overlay -->
<div class="fixed inset-0 -z-10">
  <div class="w-full h-full bg-cover bg-center"
       style="background-image:url('https://images.unsplash.com/photo-1721623777765-1381ba32859c?auto=format&fit=crop&w=1800&q=60');"></div>
  <div class="absolute inset-0 bg-black/60"></div>
</div>

<!-- Page container -->
<div class="relative z-10 pt-16 sm:pt-20 px-4 sm:px-6 lg:px-8 pb-16">
  <div class="max-w-7xl mx-auto">

    <!-- Top: Artist portrait + name + meta -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-start">
      <!-- Portrait + name -->
      <div class="flex flex-col items-center lg:items-start gap-6">
        <!-- Portrait: graceful fallback if URL missing/broken -->
        <div class="w-[260px] h-[360px] sm:w-[320px] sm:h-[440px] rounded-[2rem] overflow-hidden bg-gray-800/50 shadow-2xl ring-1 ring-white/10">
          <img
            src="{{ artist.image_url|default:'https://images.unsplash.com/photo-1593459866242-426f7768f3dc?auto=format&fit=crop&w=900&q=60' }}"
            alt="{{ artist.name }}"
            class="w-full h-full object-cover"
            loading="lazy"
            onerror="this.src='https://images.unsplash.com/photo-1593459866242-426f7768f3dc?auto=format&fit=crop&w=900&q=60';"
          >
        </div>

        <div class="text-center lg:text-left">
          <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight">
            {{ artist.name }}
          </h1>
          <p class="mt-2 text-white/70">
            {% with cnt=songs|length %}{{ cnt }} song{{ cnt|pluralize }}{% endwith %}
            {% if year_min and year_max %} • {{ year_min }}–{{ year_max }}{% endif %}
          </p>
          {% if avg_rating %}
          <p class="mt-2 text-white/80">Rating: <span class="text-yellow-400 font-semibold">{{ avg_rating|floatformat:1 }}/5.0</span></p>
          {% endif %}
          {% if view_count %}
          <p class="mt-2 text-white/70 flex items-center gap-2 {% if not avg_rating %}mt-2{% endif %} justify-center lg:justify-start">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            <span>{{ view_count|floatformat:0 }} view{{ view_count|pluralize }}</span>
          </p>
          {% endif %}
          {% if user.is_authenticated %}
          <form method="post" action="{% url 'toggle_favorite_artist' artist.id %}" class="mt-3">
            {% csrf_token %}
            <button type="submit" class="inline-flex items-center gap-2 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full text-sm transition {% if is_favorite %}text-red-400{% endif %}">
              {% if is_favorite %}♥ Favorited{% else %}♡ Add to Favorites{% endif %}
            </button>
          </form>
          {% endif %}
        </div>
      </div>

      <!-- About card -->
      <div class="w-full">
        {% if artist.about %}
          <div class="bg-white/10 backdrop-blur-md rounded-2xl p-5 sm:p-6 lg:p-8 shadow-xl ring-1 ring-white/10">
            <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4">About Artist</h2>
            <p class="text-white/85 leading-relaxed text-sm sm:text-base">
              {{ artist.about }}
            </p>
          </div>
        {% else %}
          <div class="bg-white/5 backdrop-blur-md rounded-2xl p-5 sm:p-6 lg:p-8 ring-1 ring-white/10 text-white/70">
            No bio yet. Add one in Admin → Artist → “About”.
          </div>
        {% endif %}
      </div>
    </section>

    <!-- Songs -->
    <section class="mt-10 sm:mt-12">
      <div class="flex items-end justify-between mb-4 sm:mb-6">
        <h2 class="text-2xl sm:text-3xl font-bold">Popular Songs</h2>
        {% if songs|length > 9 %}
        <button id="toggleSongs"
                data-more="Show all"
                data-less="Show less"
                class="hidden sm:inline-flex items-center gap-2 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full text-sm transition">
          Show all
          <svg id="toggleIcon" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-width="2" d="M6 9l6 6 6-6"/>
          </svg>
        </button>
        {% endif %}
      </div>

      <ul id="songsGrid"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
        {% for s in songs %}
          <li class="{% if forloop.counter > 9 %}hidden extra-song{% endif %}">
            <a href="{% url 'song_detail' artist=artist.slug song=s.slug %}"
               class="group block bg-white/8 hover:bg-white/12 ring-1 ring-white/10 rounded-2xl p-3 sm:p-4 transition">
              <!-- Square art stub / initial -->
              <div class="aspect-square rounded-xl overflow-hidden bg-gradient-to-br from-white/10 to-white/20 mb-3">
                <div class="w-full h-full flex items-center justify-center text-3xl sm:text-4xl font-bold text-white/80 group-hover:scale-105 transition">
                  {{ s.title|first|upper }}
                </div>
              </div>
              <div class="px-0.5">
                <h3 class="font-semibold truncate">{{ s.title }}</h3>
                <p class="text-white/70 text-sm">
                  {% if s.year %}{{ s.year }}{% endif %}
                </p>
              </div>
            </a>
          </li>
        {% empty %}
          <li class="text-white/70">No songs yet. Import a CSV and mark songs as “published”.</li>
        {% endfor %}
      </ul>

      {% if songs|length > 9 %}
      <div class="sm:hidden mt-4 flex justify-center">
        <button id="toggleSongsSm"
                data-more="Show all"
                data-less="Show less"
                class="inline-flex items-center gap-2 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full text-sm transition">
          Show all
          <svg id="toggleIconSm" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-width="2" d="M6 9l6 6 6-6"/>
          </svg>
        </button>
      </div>
      {% endif %}
    </section>

    <!-- Ratings Section -->
    {% if user.is_authenticated %}
    <section class="mt-10 sm:mt-12">
      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-5 sm:p-6 lg:p-8 shadow-xl ring-1 ring-white/10">
        <h2 class="text-xl sm:text-2xl font-bold mb-4">Rate This Artist</h2>
        <form method="post" id="ratingForm" class="space-y-4">
          {% csrf_token %}
          <div class="flex gap-4 items-center">
            <div class="star-rating" data-rating="{{ user_rating.rating|default:0 }}">
              <input type="hidden" name="rating" id="ratingInput" value="{{ user_rating.rating|default:0 }}">
              <span class="star" data-value="1">★</span>
              <span class="star" data-value="2">★</span>
              <span class="star" data-value="3">★</span>
              <span class="star" data-value="4">★</span>
              <span class="star" data-value="5">★</span>
            </div>
            <button type="submit" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full text-sm transition">Submit Rating</button>
          </div>
          {% if user_rating %}
          <p class="text-sm text-white/60">Your current rating: <span id="currentRating">{{ user_rating.rating }}</span>/5</p>
          {% endif %}
        </form>
      </div>
    </section>
    {% endif %}

    <!-- Comments Section -->
    <section class="mt-10 sm:mt-12">
      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-5 sm:p-6 lg:p-8 shadow-xl ring-1 ring-white/10">
        <h2 class="text-xl sm:text-2xl font-bold mb-6">Comments</h2>

        {% if user.is_authenticated %}
        <form method="post" class="mb-8">
          {% csrf_token %}
          {{ comment_form.text }}
          <input type="hidden" name="comment_text" value="1">
          <button type="submit" class="mt-3 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full text-sm transition">Post Comment</button>
        </form>
        {% else %}
        <p class="mb-8 text-white/60">
          <a href="{% url 'login' %}?next={{ request.path }}" class="underline hover:no-underline">Login</a> to leave a comment
        </p>
        {% endif %}

        {% if comments %}
        <div class="space-y-4">
          {% for comment in comments %}
          <div class="p-4 bg-white/5 rounded-lg border border-white/10">
            <div class="flex justify-between items-start mb-2">
              <span class="font-semibold">{{ comment.user.username }}</span>
              <span class="text-xs text-white/50">{{ comment.created_at|timesince }} ago</span>
            </div>
            <p class="text-white/80">{{ comment.text }}</p>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-white/60">No comments yet. Be the first to comment!</p>
        {% endif %}
      </div>
    </section>

  </div>
</div>

<style>
  .star-rating {
    display: inline-flex;
    gap: 0.25rem;
    font-size: 2rem;
    cursor: pointer;
  }
  .star {
    color: rgba(255, 255, 255, 0.2);
    transition: color 0.2s;
    cursor: pointer;
  }
  .star.filled {
    color: #fbbf24;
  }
  .star:hover {
    color: #fbbf24;
  }
</style>

<script>
  // Show all / Show less for songs (desktop + mobile buttons)
  const toggle = (btnId, iconId) => {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    const icon = document.getElementById(iconId);
    let open = false;
    btn.addEventListener('click', () => {
      document.querySelectorAll('.extra-song').forEach(el => el.classList.toggle('hidden'));
      open = !open;
      btn.textContent = open ? btn.dataset.less : btn.dataset.more;
      if (icon) btn.appendChild(icon);
    });
  };
  toggle('toggleSongs', 'toggleIcon');
  toggle('toggleSongsSm', 'toggleIconSm');

  // Star rating functionality
  document.addEventListener('DOMContentLoaded', function() {
    const starRating = document.querySelector('.star-rating');
    if (!starRating) return;

    const stars = starRating.querySelectorAll('.star');
    const ratingInput = document.getElementById('ratingInput');
    const currentRatingSpan = document.getElementById('currentRating');
    let currentRating = parseInt(starRating.dataset.rating) || 0;

    // Initialize stars based on current rating
    function updateStars(rating) {
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.add('filled');
        } else {
          star.classList.remove('filled');
        }
      });
    }

    updateStars(currentRating);

    // Hover effect
    stars.forEach((star, index) => {
      star.addEventListener('mouseenter', () => {
        updateStars(index + 1);
      });
    });

    // Reset to current rating on mouse leave
    starRating.addEventListener('mouseleave', () => {
      updateStars(currentRating);
    });

    // Click to select rating
    stars.forEach((star, index) => {
      star.addEventListener('click', () => {
        currentRating = index + 1;
        ratingInput.value = currentRating;
        updateStars(currentRating);
        if (currentRatingSpan) {
          currentRatingSpan.textContent = currentRating;
        }
      });
    });
  });
</script>
{% endblock %}
